---
interface MediaItem {
  src: string;
  isVideo?: boolean;
}

interface Props {
  sources: MediaItem[];
  title: string;
  description: string;
}

const { sources, title, description } = Astro.props;
const cardId = `card-${Math.random().toString(36).slice(2, 9)}`;
---

<div
  class="flex-1 flex flex-col items-center p-0 box-border rounded border-2 border-custom-black text-base"
>
  <div
    class="relative w-full overflow-hidden"
    data-card-gallery={cardId}
    data-slide-count={sources.length}
  >
    <div
      class="flex transition-transform duration-300 ease-in-out"
      data-slides-track
    >
      {
        sources.map((item, index) => (
          <div class="card-slide w-full shrink-0" data-slide-index={index}>
            {item.isVideo ? (
              <video
                src={item.src}
                autoplay
                muted
                loop
                playsinline
                class="w-full h-auto object-cover cursor-default p-1"
              />
            ) : (
              <img
                src={item.src}
                alt={`${title} - ${index + 1}`}
                class="w-full h-auto object-cover cursor-default p-1"
              />
            )}
          </div>
        ))
      }
    </div>
    {
      sources.length > 1 && (
        <div class="flex justify-center gap-2 py-2" data-dots-container>
          {sources.map((_, index) => (
            <button
              class={`w-2 h-2 rounded-full transition-colors cursor-pointer ${index === 0 ? "bg-custom-black" : "bg-gray-300"}`}
              data-dot-index={index}
              aria-label={`Go to slide ${index + 1}`}
            />
          ))}
        </div>
      )
    }
  </div>

  <h3 class="font-aileron-regular mb-1 text-xl mt-2">{title}</h3>
  <p class="text-sm font-inter px-3 pb-1">{description}</p>
  <div class="mt-2 mb-3">
    <slot />
  </div>
</div>

<script define:vars={{ cardId, slideCount: sources.length }}>
  if (slideCount > 1) {
    document.addEventListener("DOMContentLoaded", () => {
      const gallery = document.querySelector(`[data-card-gallery="${cardId}"]`);
      if (!gallery) return;

      const track = gallery.querySelector("[data-slides-track]");
      const dots = gallery.querySelectorAll("[data-dot-index]");
      let currentIndex = 0;

      function goToSlide(index) {
        dots[currentIndex].classList.remove("bg-custom-black");
        dots[currentIndex].classList.add("bg-gray-300");

        currentIndex = index;

        track.style.transform = `translateX(-${currentIndex * 100}%)`;
        dots[currentIndex].classList.add("bg-custom-black");
        dots[currentIndex].classList.remove("bg-gray-300");
      }

      function nextSlide() {
        const next = (currentIndex + 1) % slideCount;
        goToSlide(next);
      }

      function prevSlide() {
        const prev = (currentIndex - 1 + slideCount) % slideCount;
        goToSlide(prev);
      }

      // Auto-advance every 10 seconds
      let autoAdvanceTimer = setInterval(nextSlide, 10000);

      function resetTimer() {
        clearInterval(autoAdvanceTimer);
        autoAdvanceTimer = setInterval(nextSlide, 10000);
      }

      // Click handlers for dots
      dots.forEach((dot, index) => {
        dot.addEventListener("click", () => {
          goToSlide(index);
          resetTimer();
        });
      });

      // Mouse drag functionality
      let isDragging = false;
      let startX = 0;
      let currentTranslate = 0;

      gallery.addEventListener("mousedown", (e) => {
        // Don't start drag if clicking on a button or interactive element
        if (e.target.closest("button, a, [data-dialog-trigger]")) return;
        isDragging = true;
        startX = e.clientX;
        track.style.transition = "none";
        gallery.style.cursor = "grabbing";
      });

      gallery.addEventListener("mousemove", (e) => {
        if (!isDragging) return;
        const diff = e.clientX - startX;
        const baseTranslate = -currentIndex * 100;
        const percentDiff = (diff / gallery.offsetWidth) * 100;
        currentTranslate = baseTranslate + percentDiff;
        track.style.transform = `translateX(${currentTranslate}%)`;
      });

      function endDrag(e) {
        if (!isDragging) return;
        isDragging = false;
        track.style.transition = "";
        gallery.style.cursor = "";

        const diff = e.clientX - startX;
        const threshold = gallery.offsetWidth * 0.2;

        if (diff < -threshold && currentIndex < slideCount - 1) {
          nextSlide();
          resetTimer();
        } else if (diff > threshold && currentIndex > 0) {
          prevSlide();
          resetTimer();
        } else {
          track.style.transform = `translateX(-${currentIndex * 100}%)`;
        }
      }

      gallery.addEventListener("mouseup", endDrag);
      gallery.addEventListener("mouseleave", endDrag);

      // Touch support
      gallery.addEventListener("touchstart", (e) => {
        isDragging = true;
        startX = e.touches[0].clientX;
        track.style.transition = "none";
      });

      gallery.addEventListener("touchmove", (e) => {
        if (!isDragging) return;
        const diff = e.touches[0].clientX - startX;
        const baseTranslate = -currentIndex * 100;
        const percentDiff = (diff / gallery.offsetWidth) * 100;
        currentTranslate = baseTranslate + percentDiff;
        track.style.transform = `translateX(${currentTranslate}%)`;
      });

      gallery.addEventListener("touchend", (e) => {
        if (!isDragging) return;
        isDragging = false;
        track.style.transition = "";

        const diff = e.changedTouches[0].clientX - startX;
        const threshold = gallery.offsetWidth * 0.2;

        if (diff < -threshold && currentIndex < slideCount - 1) {
          nextSlide();
          resetTimer();
        } else if (diff > threshold && currentIndex > 0) {
          prevSlide();
          resetTimer();
        } else {
          track.style.transform = `translateX(-${currentIndex * 100}%)`;
        }
      });

      // Prevent image dragging
      gallery.querySelectorAll("img, video").forEach((el) => {
        el.addEventListener("dragstart", (e) => e.preventDefault());
      });
    });
  }
</script>
